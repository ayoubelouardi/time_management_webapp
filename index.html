<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Time Planner</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://emojigraph.org/media/apple/spiral-calendar_1f5d3-fe0f.png">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        /* CSS Variables for Theme Support */
        :root {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f9fafb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-accent: #4f46e5;
            --border-color: #d1d5db;
            --border-focus: #6366f1;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-lg: rgba(0, 0, 0, 0.15);
        }

        .dark {
            --bg-primary: #1f2937;
            --bg-secondary: #374151;
            --bg-tertiary: #4b5563;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-accent: #818cf8;
            --border-color: #4b5563;
            --border-focus: #818cf8;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-lg: rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Update existing styles to use variables */
        .bg-white { background-color: var(--bg-secondary) !important; }
        .text-gray-800 { color: var(--text-primary) !important; }
        .text-gray-600 { color: var(--text-secondary) !important; }
        .text-gray-500 { color: var(--text-secondary) !important; }
        .text-gray-700 { color: var(--text-primary) !important; }
        .border-gray-300 { border-color: var(--border-color) !important; }
        .bg-gray-50 { background-color: var(--bg-tertiary) !important; }

        /* Dark mode specific overrides */
        .dark .shadow-md { box-shadow: 0 4px 6px -1px var(--shadow), 0 2px 4px -1px var(--shadow); }
        .dark .shadow-lg { box-shadow: 0 10px 15px -3px var(--shadow-lg), 0 4px 6px -2px var(--shadow); }
        .dark .shadow-sm { box-shadow: 0 1px 2px 0 var(--shadow); }

        /* Custom scrollbar for both themes */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-primary);
        }

        /* Dark mode toggle switch styles */
        .toggle-checkbox {
            transition: all 0.3s ease;
        }
        .toggle-checkbox:checked {
            transform: translateX(100%);
            border-color: #4f46e5;
        }
        .toggle-label {
            transition: background-color 0.3s ease;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }

        /* Simple animation for modals and blocks */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        /* Style for completed tasks */
        .task-completed span {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        /* Dark mode input and button overrides */
        .dark input[type="time"],
        .dark input[type="text"],
        .dark input[type="number"],
        .dark textarea {
            background-color: var(--bg-tertiary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        .dark input[type="time"]:focus,
        .dark input[type="text"]:focus,
        .dark input[type="number"]:focus,
        .dark textarea:focus {
            border-color: var(--border-focus);
            --tw-ring-color: var(--border-focus);
        }

        /* Dark mode title override */
        .dark h1 {
            color: var(--text-primary) !important;
        }

        /* Dark mode modal titles override (only for modal h3 elements) */
        .dark .fixed h3 {
            color: var(--text-primary) !important;
        }

        /* Dark mode cancel button text override */
        .dark button[id*="cancel"] {
            color: #1f2937 !important; /* Dark text for light gray buttons */
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Application Container -->
    <div id="app" class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8 relative">
            <!-- Settings Button -->
            <button id="settings-btn" class="absolute top-0 right-0 p-2 text-gray-600 hover:text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>
            <h1 class="text-4xl font-bold text-gray-900">üóìÔ∏è Daily Time Planner</h1>
            <p class="text-lg text-gray-600 mt-2">Structure your day, budget your time, and get things done.</p>
        </header>

        <!-- Section 1: Day Setup (Visible initially or when no day is set) -->
        <div id="setup-section" class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold mb-4 text-center">Define Your Day</h2>
            <div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
                <div class="w-full sm:w-auto">
                    <label for="wake-up-time" class="block text-sm font-medium text-gray-700">Wake-up Time</label>
                    <input type="time" id="wake-up-time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" value="07:00">
                </div>
                <div class="w-full sm:w-auto">
                    <label for="sleep-time" class="block text-sm font-medium text-gray-700">Sleep Time</label>
                    <input type="time" id="sleep-time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" value="23:00">
                </div>
                <button id="set-day-btn" class="w-full sm:w-auto mt-4 sm:mt-6 px-6 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Set Day</button>
            </div>
             <button id="reset-day-btn" class="w-full sm:w-auto mt-4 px-6 py-2 border border-red-500 text-base font-medium rounded-md shadow-sm text-red-500 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-400 hidden">Reset Day Plan</button>
        </div>

        <!-- Section 2: Main Planner (Hidden until day is set) -->
        <div id="planner-section" class="hidden">
            <!-- Time Stats Display -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center">
                <div class="bg-green-100 text-green-800 p-4 rounded-lg shadow">
                    <h3 class="font-bold text-lg">Total Time</h3>
                    <p id="total-time-display" class="text-2xl font-semibold"></p>
                </div>
                <div class="bg-blue-100 text-blue-800 p-4 rounded-lg shadow">
                    <h3 class="font-bold text-lg">Allocated</h3>
                    <p id="allocated-time-display" class="text-2xl font-semibold"></p>
                </div>
                <div class="bg-yellow-100 text-yellow-800 p-4 rounded-lg shadow">
                    <h3 class="font-bold text-lg">Remaining</h3>
                    <p id="remaining-time-display" class="text-2xl font-semibold"></p>
                </div>
            </div>

            <!-- Block Creation -->
            <div class="text-center mb-8">
                <button id="add-block-btn" class="px-8 py-3 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    + Add Time Block
                </button>
            </div>

            <!-- Blocks Container -->
            <div id="blocks-container" class="space-y-6">
                <!-- Time blocks will be dynamically inserted here -->
            </div>
        </div>

    </div>

    <!-- Modal for adding a new block -->
    <div id="add-block-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white fade-in">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Create a New Time Block</h3>
                <div class="mt-2 px-7 py-3">
                    <input type="text" id="block-purpose-input" placeholder="Purpose (e.g., Morning Routine)" class="mb-3 px-3 py-2 text-gray-900 placeholder-gray-500 border border-gray-300 rounded-md w-full focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    
                    <!-- Time Selection Mode Toggle -->
                    <div class="mb-4">
                        <div class="flex items-center justify-center space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="time-mode" value="duration" id="duration-mode" checked class="mr-2">
                                <span class="text-sm text-gray-700">Duration Mode</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="time-mode" value="range" id="range-mode" class="mr-2">
                                <span class="text-sm text-gray-700">Time Range Mode</span>
                            </label>
                        </div>
                    </div>

                    <!-- Duration Mode (Default) -->
                    <div id="duration-mode-section">
                        <div class="flex space-x-2 mb-3">
                            <div class="flex-1">
                                <input type="number" id="block-hours-input" placeholder="Hours" min="0" max="23" value="1" class="px-3 py-2 text-gray-900 placeholder-gray-500 border border-gray-300 rounded-md w-full focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="flex-1">
                                <input type="number" id="block-minutes-input" placeholder="Minutes" min="0" max="59" value="0" class="px-3 py-2 text-gray-900 placeholder-gray-500 border border-gray-300 rounded-md w-full focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                    </div>

                    <!-- Time Range Mode (Hidden by default) -->
                    <div id="range-mode-section" class="hidden">
                        <div class="space-y-3 mb-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 text-left">Start Time</label>
                                <input type="time" id="block-start-time" value="09:00" class="px-3 py-2 text-gray-900 border border-gray-300 rounded-md w-full focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 text-left">End Time</label>
                                <input type="time" id="block-end-time" value="10:00" class="px-3 py-2 text-gray-900 border border-gray-300 rounded-md w-full focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div id="calculated-duration" class="text-sm text-gray-600 text-left">
                                Duration: <span id="duration-display">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="save-block-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        Save Block
                    </button>
                     <button id="cancel-block-btn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for task details -->
    <div id="task-details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white fade-in">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="task-modal-title">Task Details</h3>
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="task-notes-input" class="block text-sm font-medium text-gray-700">Notes & Comments</label>
                        <textarea id="task-notes-input" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Add any relevant details here..."></textarea>
                    </div>
                </div>
                <div class="items-center px-4 py-3 mt-4 text-right">
                    <button id="save-task-details-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        Save Details
                    </button>
                    <button id="cancel-task-details-btn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white fade-in">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Settings</h3>
                <div class="space-y-4">
                    <div>
                        <label for="settings-wake-time" class="block text-sm font-medium text-gray-700">Wake-up Time</label>
                        <input type="time" id="settings-wake-time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="settings-sleep-time" class="block text-sm font-medium text-gray-700">Sleep Time</label>
                        <input type="time" id="settings-sleep-time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex items-center justify-between pt-2">
                        <label for="dark-mode-toggle" class="text-sm font-medium text-gray-700">üåô Dark Mode</label>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none">
                            <input type="checkbox" id="dark-mode-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-2 appearance-none cursor-pointer transform transition-transform duration-300 ease-in-out"/>
                            <label for="dark-mode-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300 ease-in-out"></label>
                        </div>
                    </div>
                </div>
                <div class="items-center px-4 py-3 mt-6 text-right">
                    <button id="save-settings-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        Save Settings
                    </button>
                    <button id="cancel-settings-btn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Application Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT REFERENCES ---
            const setupSection = document.getElementById('setup-section');
            const plannerSection = document.getElementById('planner-section');
            const wakeUpInput = document.getElementById('wake-up-time');
            const sleepInput = document.getElementById('sleep-time');
            const setDayBtn = document.getElementById('set-day-btn');
            const resetDayBtn = document.getElementById('reset-day-btn');
            
            const totalTimeDisplay = document.getElementById('total-time-display');
            const allocatedTimeDisplay = document.getElementById('allocated-time-display');
            const remainingTimeDisplay = document.getElementById('remaining-time-display');
            
            const addBlockBtn = document.getElementById('add-block-btn');
            const blocksContainer = document.getElementById('blocks-container');

            // Modals
            const addBlockModal = document.getElementById('add-block-modal');
            const blockPurposeInput = document.getElementById('block-purpose-input');
            
            // New time selection elements
            const durationModeRadio = document.getElementById('duration-mode');
            const rangeModeRadio = document.getElementById('range-mode');
            const durationModeSection = document.getElementById('duration-mode-section');
            const rangeModeSection = document.getElementById('range-mode-section');
            const blockHoursInput = document.getElementById('block-hours-input');
            const blockMinutesInput = document.getElementById('block-minutes-input');
            const blockStartTimeInput = document.getElementById('block-start-time');
            const blockEndTimeInput = document.getElementById('block-end-time');
            const durationDisplay = document.getElementById('duration-display');
            
            const saveBlockBtn = document.getElementById('save-block-btn');
            const cancelBlockBtn = document.getElementById('cancel-block-btn');

            const taskDetailsModal = document.getElementById('task-details-modal');
            const taskModalTitle = document.getElementById('task-modal-title');
            const taskNotesInput = document.getElementById('task-notes-input');
            const saveTaskDetailsBtn = document.getElementById('save-task-details-btn');
            const cancelTaskDetailsBtn = document.getElementById('cancel-task-details-btn');

            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const settingsWakeTimeInput = document.getElementById('settings-wake-time');
            const settingsSleepTimeInput = document.getElementById('settings-sleep-time');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const cancelSettingsBtn = document.getElementById('cancel-settings-btn');
            const darkModeToggle = document.getElementById('dark-mode-toggle');

            // --- APPLICATION STATE ---
            let state = {
                dayIsSet: false,
                wakeTime: '07:00',
                sleepTime: '23:00',
                blocks: [],
                editingTaskId: null, // format: { blockId, taskId }
                darkMode: false, // NEW: Dark mode preference
            };

            // --- UTILITY FUNCTIONS ---
            const timeToMinutes = (timeStr) => {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            };

            const minutesToHM = (minutes) => {
                if (minutes < 0) minutes = 0;
                const h = Math.floor(minutes / 60);
                const m = minutes % 60;
                return `${h}h ${m}m`;
            };

            const minutesToTime = (minutes) => {
                const h = Math.floor(minutes / 60) % 24;
                const m = minutes % 60;
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            };

            // --- DARK MODE UTILITIES ---
            const applyTheme = (isDark) => {
                document.body.classList.toggle('dark', isDark);
                // Update any dynamic elements that need theme awareness
                const modals = document.querySelectorAll('[id$="-modal"]');
                modals.forEach(modal => {
                    const content = modal.querySelector('.bg-white');
                    if (content) {
                        content.style.backgroundColor = isDark ? 'var(--bg-secondary)' : '';
                        content.style.color = isDark ? 'var(--text-primary)' : '';
                    }
                });
            };

            const toggleDarkMode = (enabled) => {
                state.darkMode = enabled;
                applyTheme(enabled);
                saveState();
            };

            // --- TIME BLOCK MODE UTILITIES ---
            const switchTimeMode = (mode) => {
                if (mode === 'duration') {
                    durationModeSection.classList.remove('hidden');
                    rangeModeSection.classList.add('hidden');
                } else if (mode === 'range') {
                    durationModeSection.classList.add('hidden');
                    rangeModeSection.classList.remove('hidden');
                    updateCalculatedDuration();
                }
            };

            const updateCalculatedDuration = () => {
                const startTime = blockStartTimeInput.value;
                const endTime = blockEndTimeInput.value;
                
                if (startTime && endTime) {
                    const startMinutes = timeToMinutes(startTime);
                    const endMinutes = timeToMinutes(endTime);
                    
                    if (endMinutes > startMinutes) {
                        const duration = endMinutes - startMinutes;
                        durationDisplay.textContent = minutesToHM(duration);
                        return duration;
                    } else {
                        durationDisplay.textContent = 'Invalid time range';
                        return 0;
                    }
                } else {
                    durationDisplay.textContent = '--';
                    return 0;
                }
            };

            const validateTimeRange = (startTime, endTime) => {
                const wakeMinutes = timeToMinutes(state.wakeTime);
                const sleepMinutes = timeToMinutes(state.sleepTime);
                const startMinutes = timeToMinutes(startTime);
                const endMinutes = timeToMinutes(endTime);

                // Check if times are within wake/sleep schedule
                if (startMinutes < wakeMinutes || endMinutes > sleepMinutes) {
                    return `Time must be within your day schedule (${state.wakeTime} - ${state.sleepTime})`;
                }

                // Sort blocks by start time (same logic as renderBlocks)
                const sortedBlocks = [...state.blocks].sort((a, b) => {
                    if (a.startTime && b.startTime) {
                        return timeToMinutes(a.startTime) - timeToMinutes(b.startTime);
                    } else if (a.startTime && !b.startTime) {
                        return -1; // Scheduled blocks come first
                    } else if (!a.startTime && b.startTime) {
                        return 1;
                    }
                    return 0; // Keep original order for non-scheduled blocks
                });

                let cumulativeTime = wakeMinutes; // Track sequential block timing

                for (const block of sortedBlocks) {
                    let blockStart, blockEnd;
                    
                    if (block.startTime && block.endTime) {
                        // Block has specific start/end times
                        blockStart = timeToMinutes(block.startTime);
                        blockEnd = timeToMinutes(block.endTime);
                        // Update cumulative time if this scheduled block extends past current time
                        if (blockEnd > cumulativeTime) {
                            cumulativeTime = blockEnd;
                        }
                    } else {
                        // Block uses sequential timing - starts after previous blocks
                        blockStart = cumulativeTime;
                        blockEnd = cumulativeTime + block.duration;
                        cumulativeTime = blockEnd;
                    }
                    
                    // Check for overlap: new block overlaps if it starts before existing ends AND ends after existing starts
                    if (startMinutes < blockEnd && endMinutes > blockStart) {
                        const blockTimeDisplay = block.startTime && block.endTime 
                            ? `${block.startTime} - ${block.endTime}`
                            : `${minutesToTime(blockStart)} - ${minutesToTime(blockEnd)}`;
                        return `Time range overlaps with existing block: "${block.purpose}" (${blockTimeDisplay})`;
                    }
                }

                return null; // No validation errors
            };
            
            // --- STATE MANAGEMENT & PERSISTENCE ---
            const saveState = () => {
                localStorage.setItem('timePlannerState', JSON.stringify(state));
            };

            const loadState = () => {
                const savedState = localStorage.getItem('timePlannerState');
                if (savedState) {
                    state = JSON.parse(savedState);
                    // Apply theme after loading state
                    applyTheme(state.darkMode || false);
                }
            };
            
            // --- RENDERING & UI UPDATES ---
            const render = () => {
                if (state.dayIsSet) {
                    setupSection.classList.add('hidden');
                    plannerSection.classList.remove('hidden');
                    resetDayBtn.classList.remove('hidden');
                    wakeUpInput.value = state.wakeTime;
                    sleepInput.value = state.sleepTime;
                } else {
                    setupSection.classList.remove('hidden');
                    plannerSection.classList.add('hidden');
                    resetDayBtn.classList.add('hidden');
                }
                
                renderTimeStats();
                renderBlocks();
            };
            
            const renderTimeStats = () => {
                let totalMinutes = timeToMinutes(state.sleepTime) - timeToMinutes(state.wakeTime);
                if (totalMinutes < 0) { // Handles overnight case
                    totalMinutes += 24 * 60;
                }
                const allocatedMinutes = state.blocks.reduce((sum, block) => sum + block.duration, 0);
                const remainingMinutes = totalMinutes - allocatedMinutes;
                
                totalTimeDisplay.textContent = minutesToHM(totalMinutes);
                allocatedTimeDisplay.textContent = minutesToHM(allocatedMinutes);
                remainingTimeDisplay.textContent = minutesToHM(remainingMinutes);

                // Disable add block button if no time is left
                addBlockBtn.disabled = remainingMinutes <= 0;
                addBlockBtn.classList.toggle('opacity-50', remainingMinutes <= 0);
                addBlockBtn.classList.toggle('cursor-not-allowed', remainingMinutes <= 0);
            };

            const renderBlocks = () => {
                blocksContainer.innerHTML = '';
                let cumulativeTime = timeToMinutes(state.wakeTime);

                // Sort blocks by start time if they have specific times, otherwise by order
                const sortedBlocks = [...state.blocks].sort((a, b) => {
                    if (a.startTime && b.startTime) {
                        return timeToMinutes(a.startTime) - timeToMinutes(b.startTime);
                    } else if (a.startTime && !b.startTime) {
                        return -1; // Scheduled blocks come first
                    } else if (!a.startTime && b.startTime) {
                        return 1;
                    }
                    return 0; // Keep original order for non-scheduled blocks
                });

                sortedBlocks.forEach(block => {
                    const blockEl = document.createElement('div');
                    blockEl.className = 'bg-white p-5 rounded-lg shadow-md fade-in';
                    blockEl.dataset.id = block.id;

                    let startTime, endTime, timeDisplay;

                    if (block.startTime && block.endTime) {
                        // Block has specific start/end times
                        startTime = block.startTime;
                        endTime = block.endTime;
                        timeDisplay = `${minutesToHM(block.duration)} (${startTime} - ${endTime}) ‚è∞`;
                    } else {
                        // Block uses sequential timing
                        startTime = minutesToTime(cumulativeTime);
                        cumulativeTime += block.duration;
                        endTime = minutesToTime(cumulativeTime);
                        timeDisplay = `${minutesToHM(block.duration)} (${startTime} - ${endTime})`;
                    }

                    let tasksHtml = block.tasks.map(task => `
                        <li class="flex items-center justify-between py-2 border-b" data-id="${task.id}">
                            <div class="flex items-center flex-grow">
                                <input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 task-checkbox" ${task.completed ? 'checked' : ''}>
                                <span class="ml-3 text-gray-800 flex-grow cursor-pointer task-text">${task.text}</span>
                            </div>
                            <button class="text-red-500 hover:text-red-700 font-semibold ml-2 delete-task-btn">Delete</button>
                        </li>
                    `).join('');
                    
                    blockEl.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-indigo-700">${block.purpose}</h3>
                                <p class="text-sm text-gray-500">${timeDisplay}</p>
                            </div>
                            <button class="text-red-600 hover:text-red-800 font-bold delete-block-btn">‚úï</button>
                        </div>
                        <ul class="task-list space-y-2 mb-4">${tasksHtml}</ul>
                        <div class="flex gap-2 mt-4">
                            <input type="text" class="flex-grow px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 new-task-input" placeholder="Add a new task...">
                            <button class="px-4 py-2 border border-transparent font-medium rounded-md shadow-sm text-white bg-indigo-500 hover:bg-indigo-600 add-task-btn">Add</button>
                        </div>
                    `;
                    blocksContainer.appendChild(blockEl);
                });
            };

            // --- MODAL HANDLING ---
            const openModal = (modal) => modal.classList.remove('hidden');
            const closeModal = (modal) => modal.classList.add('hidden');

            // --- EVENT HANDLERS ---
            setDayBtn.addEventListener('click', () => {
                state.dayIsSet = true;
                state.wakeTime = wakeUpInput.value;
                state.sleepTime = sleepInput.value;
                saveState();
                render();
            });

            resetDayBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to reset your entire day plan? This cannot be undone.')) {
                    state.dayIsSet = false;
                    state.blocks = [];
                    saveState();
                    render();
                }
            });

            addBlockBtn.addEventListener('click', () => {
                // Set default values for all form fields
                blockPurposeInput.value = '';
                blockHoursInput.value = '1';
                blockMinutesInput.value = '0';
                blockStartTimeInput.value = '09:00';
                blockEndTimeInput.value = '10:00';
                
                // Set default mode to duration
                durationModeRadio.checked = true;
                switchTimeMode('duration');
                
                openModal(addBlockModal);
                blockPurposeInput.focus();
            });

            cancelBlockBtn.addEventListener('click', () => closeModal(addBlockModal));

            // Time mode switching event listeners
            durationModeRadio.addEventListener('change', () => {
                if (durationModeRadio.checked) {
                    switchTimeMode('duration');
                }
            });

            rangeModeRadio.addEventListener('change', () => {
                if (rangeModeRadio.checked) {
                    switchTimeMode('range');
                }
            });

            // Update calculated duration when time range changes
            blockStartTimeInput.addEventListener('input', updateCalculatedDuration);
            blockEndTimeInput.addEventListener('input', updateCalculatedDuration);
            
            saveBlockBtn.addEventListener('click', () => {
                const purpose = blockPurposeInput.value.trim();
                
                if (!purpose) {
                    alert('Please enter a purpose for the block.');
                    return;
                }

                let duration, startTime, endTime, validationError;

                // Check which mode is selected
                if (durationModeRadio.checked) {
                    // Duration Mode - Enhanced with hours and minutes
                    const hours = parseInt(blockHoursInput.value, 10) || 0;
                    const minutes = parseInt(blockMinutesInput.value, 10) || 0;
                    duration = hours * 60 + minutes;
                    
                    if (duration <= 0) {
                        alert('Please enter a valid duration (hours and/or minutes).');
                        return;
                    }
                } else {
                    // Time Range Mode - New functionality
                    startTime = blockStartTimeInput.value;
                    endTime = blockEndTimeInput.value;
                    
                    if (!startTime || !endTime) {
                        alert('Please select both start and end times.');
                        return;
                    }
                    
                    // Validate time range
                    validationError = validateTimeRange(startTime, endTime);
                    if (validationError) {
                        alert(validationError);
                        return;
                    }
                    
                    // Calculate duration from time range
                    duration = updateCalculatedDuration();
                    if (duration <= 0) {
                        alert('End time must be after start time.');
                        return;
                    }
                }

                // Create new block
                const newBlock = {
                    id: Date.now(),
                    purpose,
                    duration,
                    tasks: []
                };

                // Add start/end times if in range mode
                if (rangeModeRadio.checked) {
                    newBlock.startTime = startTime;
                    newBlock.endTime = endTime;
                }

                state.blocks.push(newBlock);
                saveState();
                render();
                closeModal(addBlockModal);
                
                // Reset form
                blockPurposeInput.value = '';
                blockHoursInput.value = '';
                blockMinutesInput.value = '';
                blockStartTimeInput.value = '';
                blockEndTimeInput.value = '';
                durationModeRadio.checked = true;
                switchTimeMode('duration');
            });

            blocksContainer.addEventListener('click', (e) => {
                // First, check for task-specific actions
                const taskEl = e.target.closest('li[data-id]');
                if (taskEl) {
                    const blockEl = taskEl.closest('div[data-id]');
                    const blockId = Number(blockEl.dataset.id);
                    const taskId = Number(taskEl.dataset.id);

                    // Delete Task
                    if (e.target.matches('.delete-task-btn')) {
                        const block = state.blocks.find(b => b.id === blockId);
                        block.tasks = block.tasks.filter(t => t.id !== taskId);
                        saveState();
                        render();
                        return;
                    }

                    // Toggle Task Completion
                    if (e.target.matches('.task-checkbox')) {
                        const block = state.blocks.find(b => b.id === blockId);
                        const task = block.tasks.find(t => t.id === taskId);
                        task.completed = e.target.checked;
                        taskEl.classList.toggle('task-completed', task.completed);
                        saveState();
                        return;
                    }

                    // Open Task Details Modal
                    if (e.target.matches('.task-text')) {
                        const block = state.blocks.find(b => b.id === blockId);
                        const task = block.tasks.find(t => t.id === taskId);
                        state.editingTaskId = { blockId, taskId };
                        taskModalTitle.textContent = `Details for: ${task.text}`;
                        taskNotesInput.value = task.notes || '';
                        openModal(taskDetailsModal);
                        return;
                    }
                }

                // Then check for block-level actions
                const blockEl = e.target.closest('div[data-id]');
                if (!blockEl) return;
                const blockId = Number(blockEl.dataset.id);

                // Delete Block
                if (e.target.matches('.delete-block-btn')) {
                    state.blocks = state.blocks.filter(b => b.id !== blockId);
                    saveState();
                    render();
                    return;
                }

                // Add Task
                if (e.target.matches('.add-task-btn')) {
                    const input = blockEl.querySelector('.new-task-input');
                    const taskText = input.value.trim();
                    if (taskText) {
                        const block = state.blocks.find(b => b.id === blockId);
                        block.tasks.push({
                            id: Date.now(),
                            text: taskText,
                            completed: false,
                            notes: ''
                        });
                        input.value = '';
                        saveState();
                        render();
                    }
                    return;
                }
            });

            saveTaskDetailsBtn.addEventListener('click', () => {
                const { blockId, taskId } = state.editingTaskId;
                const block = state.blocks.find(b => b.id === blockId);
                const task = block.tasks.find(t => t.id === taskId);
                task.notes = taskNotesInput.value.trim();
                
                saveState();
                closeModal(taskDetailsModal);
                state.editingTaskId = null;
            });

            cancelTaskDetailsBtn.addEventListener('click', () => {
                closeModal(taskDetailsModal);
                state.editingTaskId = null;
            });

            // Settings modal handlers
            settingsBtn.addEventListener('click', () => {
                settingsWakeTimeInput.value = state.wakeTime;
                settingsSleepTimeInput.value = state.sleepTime;
                darkModeToggle.checked = state.darkMode || false;
                openModal(settingsModal);
            });

            cancelSettingsBtn.addEventListener('click', () => {
                closeModal(settingsModal);
            });

            // Dark mode toggle handler
            darkModeToggle.addEventListener('change', (e) => {
                toggleDarkMode(e.target.checked);
            });

            saveSettingsBtn.addEventListener('click', () => {
                const newWakeTime = settingsWakeTimeInput.value;
                const newSleepTime = settingsSleepTimeInput.value;
                
                if (!newWakeTime || !newSleepTime) {
                    alert('Please select valid wake-up and sleep times.');
                    return;
                }

                state.wakeTime = newWakeTime;
                state.sleepTime = newSleepTime;
                // Dark mode is already handled by the toggle event listener
                saveState();
                render();
                closeModal(settingsModal);
                
                // Show a confirmation message
                alert('Settings saved successfully!');
            });
            
            // --- INITIALIZATION ---
            loadState();
            render();
        });
    </script>
</body>
</html>
